@page "/View"
@using Microsoft.AspNetCore.Html
@using System.Text
@model FontysLost_Found.Presentation.Pages.Posts.ViewModel
@functions {
    public IHtmlContent Highlight(string? text, string? term)
    {
        if (string.IsNullOrEmpty(text))
            return HtmlString.Empty;

        if (string.IsNullOrWhiteSpace(term))
            return new HtmlString(
                System.Text.Encodings.Web.HtmlEncoder.Default.Encode(text)
            );

        var input = text;
        var search = term.Trim();

        var sb = new StringBuilder();
        var idx = 0;

        while (true)
        {
            var matchIndex = input.IndexOf(search, idx, StringComparison.OrdinalIgnoreCase);
            if (matchIndex < 0)
            {
                sb.Append(
                    System.Text.Encodings.Web.HtmlEncoder.Default.Encode(
                        input.Substring(idx)
                    )
                );
                break;
            }

            // before match
            sb.Append(
                System.Text.Encodings.Web.HtmlEncoder.Default.Encode(
                    input.Substring(idx, matchIndex - idx)
                )
            );

            // match (highlighted)
            var matchText = input.Substring(matchIndex, search.Length);
            sb.Append("<mark>");
            sb.Append(
                System.Text.Encodings.Web.HtmlEncoder.Default.Encode(matchText)
            );
            sb.Append("</mark>");

            idx = matchIndex + search.Length;
        }

        return new HtmlString(sb.ToString());
    }
}

@{
    ViewData["Title"] = "Posts";
}

<h1 class="mt-4 mb-4">Posts</h1>

<form method="get" class="mb-3">
    <div class="input-group">
        <input type="text"
               name="Search"
               value="@Model.Search"
               class="form-control"
               placeholder="Search posts..." />

        <button type="submit" class="btn btn-primary">
            Search
        </button>

        @if (!string.IsNullOrEmpty(Model.Search))
        {
            <a asp-page="/Posts/View" class="btn btn-secondary">
                Clear
            </a>
        }
    </div>
</form>


@if (!Model.Posts.Any())
{
    <div class="alert alert-info">
        No posts have been created yet.
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th scope="col">Title</th>
                    <th scope="col">Description</th>
                    <th scope="col">Date Created</th>
                    <th scope="col">Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var post in Model.Posts)
                {
                    <tr style="cursor:pointer;">
                        <td>
                            <a 
                              asp-page="/Posts/Details"
                              asp-route-id="@post.Id">
                                @Highlight(post.Title, Model.Search)
                            </a>
                        </td>
                        <td>@Highlight(post.Description, Model.Search)</td>
                        <td>@post.DateCreated.ToString("dd MMM yyyy HH:mm")</td>
                        @if (User.IsInRole("Admin"))
                       {
                            <td>
                                <a asp-page="/Posts/Edit"
                                asp-route-id="@post.Id"
                                class="btn btn-sm btn-warning">
                                    Edit
                                </a>
                                <form method="post"
                                asp-page-handler="Delete"
                                asp-route-id="@post.Id"
                                class="d-inline">
                                    <button type="submit"
                                    class="btn btn-sm btn-danger"
                                    onclick="return confirm('Are you sure you want to delete this post?');">
                                        <i class="bi bi-trash"></i>
                                        🗑
                                    </button>
                                </form>
                            </td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>
}